{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2 class="mb-4">
            <i class="bi bi-tags-fill"></i> Управление категориями
        </h2>
        
        <!-- Форма создания категории -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Создать новую категорию</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Название категории *</label>
                            {{ form.name(class="form-control", placeholder="Например: Юноши 14-16 лет") }}
                            {% if form.name.errors %}
                                <div class="text-danger">
                                    {% for error in form.name.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Пол</label>
                            {{ form.gender(class="form-select") }}
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Критерий</label>
                            <select id="criteria" class="form-select" onchange="toggleCriteria()">
                                <option value="age">По возрасту</option>
                                <option value="weight">По весу</option>
                                <option value="both">Возраст + Вес</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row" id="age-criteria">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Минимальный возраст</label>
                            {{ form.min_age(class="form-control", placeholder="14") }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Максимальный возраст</label>
                            {{ form.max_age(class="form-control", placeholder="16") }}
                        </div>
                    </div>
                    
                    
                    <div class="d-grid">
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Список категорий и распределение -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-list-check"></i> Существующие категории
                            <span class="badge bg-light text-dark float-end">{{ categories|length }}</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if categories %}
                            <div class="list-group">
                                {% for category in categories %}
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ category.name }}</h6>
                                        <small>
                                            {% if category.gender == 'м' %}
                                                <span class="badge bg-primary">Мужчины</span>
                                            {% elif category.gender == 'ж' %}
                                                <span class="badge bg-danger">Женщины</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Все</span>
                                            {% endif %}
                                        </small>
                                    </div>
                                    
                                    <div class="mt-2">
                                        {% if category.min_age or category.max_age %}
                                        <span class="badge bg-info me-1">
                                            <i class="bi bi-calendar"></i>
                                            {% if category.min_age %}{{ category.min_age }}{% else %}?{% endif %}-
                                            {% if category.max_age %}{{ category.max_age }}{% else %}?{% endif %} лет
                                        </span>
                                        {% endif %}
                                        
                                        {% if category.min_weight or category.max_weight %}
                                        <span class="badge bg-warning">
                                            <i class="bi bi-speedometer2"></i>
                                            {% if category.min_weight %}{{ category.min_weight }}{% else %}?{% endif %}-
                                            {% if category.max_weight %}{{ category.max_weight }}{% else %}?{% endif %} кг
                                        </span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mt-2">
                                        {% set cat_participants = categorized.get(category.name, []) %}
                                        <small class="text-muted">
                                            <i class="bi bi-people"></i> Спортсменов: {{ cat_participants|length }}
                                        </small>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-tag display-4 text-muted"></i>
                                <p class="mt-2">Категории не созданы</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-diagram-3"></i> Распределение спортсменов
                            <span class="badge bg-light text-dark float-end">{{ participants|length }}</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if participants %}
                            <div class="accordion" id="distributionAccordion">
                                {% for category_name, participants_list in categorized.items() %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" 
                                                data-bs-toggle="collapse" 
                                                data-bs-target="#collapse{{ loop.index }}">
                                            {{ category_name }}
                                            <span class="badge bg-primary ms-2">{{ participants_list|length }}</span>
                                        </button>
                                    </h2>
                                    <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" 
                                         data-bs-parent="#distributionAccordion">
                                        <div class="accordion-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>#</th>
                                                            <th>Спортсмен</th>
                                                            <th>Клуб</th>
                                                            <th>Возр.</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for participant in participants_list %}
                                                        <tr>
                                                            <td>{{ loop.index }}</td>
                                                            <td>
                                                                {{ participant.last_name }} {{ participant.first_name }}
                                                                {% if participant.gender == 'М' %}
                                                                    <span class="badge bg-primary btn-sm">М</span>
                                                                {% elif participant.gender == 'Ж' %}
                                                                    <span class="badge bg-danger btn-sm">Ж</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>{{ participant.club or '-' }}</td>
                                                            <td>
                                                                {% if participant.birth_date %}
                                                                    {{ participant.age }}
                                                                {% else %}
                                                                    -
                                                                {% endif %}
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                                
                                {% if categorized.get('Без категории') %}
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed text-danger" type="button" 
                                                data-bs-toggle="collapse" 
                                                data-bs-target="#collapseUncategorized">
                                            <i class="bi bi-exclamation-triangle"></i> Без категории
                                            <span class="badge bg-danger ms-2">{{ categorized['Без категории']|length }}</span>
                                        </button>
                                    </h2>
                                    <div id="collapseUncategorized" class="accordion-collapse collapse" 
                                         data-bs-parent="#distributionAccordion">
                                        <div class="accordion-body">
                                            <div class="alert alert-warning">
                                                <i class="bi bi-exclamation-circle"></i>
                                                Эти спортсмены не соответствуют критериям ни одной категории.
                                                Создайте дополнительные категории или измените существующие.
                                            </div>
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Спортсмен</th>
                                                        <th>Причина</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for participant in categorized['Без категории'] %}
                                                    <tr>
                                                        <td>{{ participant.last_name }} {{ participant.first_name }}</td>
                                                        <td>
                                                            <small class="text-muted">
                                                                {% if not participant.gender %}Не указан пол{% endif %}
                                                                {% if not participant.birth_date %}Не указана дата рождения{% endif %}
                                                            </small>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="mt-3">
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle"></i>
                                    Всего спортсменов: <strong>{{ participants|length }}</strong>.
                                    Распределено по категориям: 
                                    <strong>{{ participants|length - (categorized.get('Без категории', [])|length) }}</strong>.
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-person-slash display-4 text-muted"></i>
                                <p class="mt-2">Спортсменов нет</p>
                                <a href="{{ url_for('upload_participants', id=competition.id) }}" class="btn btn-primary">
                                    <i class="bi bi-upload"></i> Загрузить спортсменов
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleCriteria() {
    const criteria = document.getElementById('criteria').value;
    const ageDiv = document.getElementById('age-criteria');
    const weightDiv = document.getElementById('weight-criteria');
    
    if (criteria === 'age') {
        ageDiv.style.display = 'flex';
        weightDiv.style.display = 'none';
    } else if (criteria === 'weight') {
        ageDiv.style.display = 'none';
        weightDiv.style.display = 'flex';
    } else if (criteria === 'both') {
        ageDiv.style.display = 'flex';
        weightDiv.style.display = 'flex';
    }
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
    toggleCriteria();
});
</script>
{% endblock %}